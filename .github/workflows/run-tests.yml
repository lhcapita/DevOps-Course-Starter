name: Continuous Integration
on: 
    push:
        paths-ignore:
            - 'README.md'
    pull_request:
        # Sequence of patterns matched against refs/heads
        branches:    
            - main  

jobs:
    job-one:
        name: Build and test
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v2
        - run: docker build --target test --tag todo-app:test .
        - run: docker run --env-file ./.env.test --mount type=bind,source="$(pwd)"/todo_app,target=/app/todo_app todo-app:test
    job-two:
        name: Job Two
        runs-on: ubuntu-latest
        needs: job-one 
        #if: ${{ github.event_name == 'pull_request' && github.ref == 'refs/heads/main'}}
        steps:
        - uses: actions/checkout@v2
        - run: echo "Publishing!"
        -
          name: Login to Docker Hub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}
            
        -
          name: Build and push
          uses: docker/build-push-action@v3
          with:
            push: true
            tags: lhcapita1/todo-app
            target: production

        - run: "curl -dH -X POST ${{ secrets.AZURE_WEBHOOK_URL }}"
        